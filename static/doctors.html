<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ä–∞—á–∏ - CRM –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .doctors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .doctor-card { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; transition: transform 0.2s, box-shadow 0.2s; }
        .doctor-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .doctor-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, #007bff, #0056b3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; margin-bottom: 15px; }
        .doctor-name { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .doctor-email { color: #666; font-size: 14px; margin-bottom: 5px; }
        .doctor-login { color: #999; font-size: 13px; margin-bottom: 10px; }
        .doctor-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .doctor-badge.admin { background: #ffc107; color: #333; }
        .doctor-badge.doctor { background: #17a2b8; color: white; }
        .doctor-actions { display: flex; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</h1>

        <div class="nav">
            <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/patients.html">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
            <a href="/appointments.html">üìÖ –ó–∞–ø–∏—Å–∏</a>
            <a href="/doctors.html" class="active">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</a>
            <a href="/services.html">‚öôÔ∏è –£—Å–ª—É–≥–∏</a>
            <a href="/reports.html">üìä –û—Ç—á—ë—Ç—ã</a>
        </div>

        <div class="quick-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ –≤—Ä–∞—á–µ–π</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="adminCount">-</div>
                <div class="stat-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-success" onclick="openModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞</button>
        </div>

        <div class="doctors-grid" id="doctorsGrid"></div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞</h2>
            <form id="form">
                <div class="form-group">
                    <label for="name">–§–ò–û *</label>
                    <input type="text" id="name" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required placeholder="doctor@clinic.com">
                </div>
                <div class="form-group">
                    <label for="login">–õ–æ–≥–∏–Ω *</label>
                    <input type="text" id="login" required placeholder="dr_ivanov">
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å <span id="passwordHint">*</span></label>
                    <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="isAdmin" style="width: auto;">
                        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast"></div>

    <script src="/static/js/common.js"></script>
    <script>
        let doctors = [];
        let editingId = null;

        async function loadData() {
            const grid = document.getElementById('doctorsGrid');
            Loading.show(grid);

            try {
                const data = await API.get('/api/doctors');
                doctors = Array.isArray(data) ? data : (data.data || []);
                document.getElementById('totalCount').textContent = doctors.length;
                document.getElementById('adminCount').textContent = doctors.filter(d => d.isAdmin).length;
                render();
            } catch (error) {
                console.error('Error:', error);
                Toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function render() {
            const grid = document.getElementById('doctorsGrid');

            if (!doctors.length) {
                EmptyState.show(grid, 'üë®‚Äç‚öïÔ∏è', '–ù–µ—Ç –≤—Ä–∞—á–µ–π');
                return;
            }

            grid.innerHTML = doctors.map(d => `
                <div class="doctor-card">
                    <div class="doctor-avatar">${getInitials(d.name)}</div>
                    <div class="doctor-name">${d.name}</div>
                    <div class="doctor-email">${d.email}</div>
                    <div class="doctor-login">@${d.login}</div>
                    <span class="doctor-badge ${d.isAdmin ? 'admin' : 'doctor'}">${d.isAdmin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–í—Ä–∞—á'}</span>
                    <div class="doctor-actions">
                        <button class="btn btn-sm btn-warning" onclick="edit(${d.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-sm btn-danger" onclick="remove(${d.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function openModal(doctor = null) {
            editingId = doctor?.id || null;
            document.getElementById('modalTitle').textContent = doctor ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–∞—á–∞' : '–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞';
            document.getElementById('form').reset();

            const passwordInput = document.getElementById('password');
            const passwordHint = document.getElementById('passwordHint');

            if (doctor) {
                document.getElementById('name').value = doctor.name || '';
                document.getElementById('email').value = doctor.email || '';
                document.getElementById('login').value = doctor.login || '';
                document.getElementById('isAdmin').checked = doctor.isAdmin || false;
                passwordInput.required = false;
                passwordInput.placeholder = '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å';
                passwordHint.textContent = '(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
            } else {
                passwordInput.required = true;
                passwordInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                passwordHint.textContent = '*';
            }

            Modal.open('modal');
        }

        function closeModal() {
            Modal.close('modal');
            editingId = null;
        }

        function edit(id) {
            const doctor = doctors.find(d => d.id === id);
            if (doctor) openModal(doctor);
        }

        async function remove(id) {
            const doctor = doctors.find(d => d.id === id);
            if (doctor && doctor.login === 'admin') {
                Toast.error('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                return;
            }

            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Ä–∞—á–∞?')) return;

            try {
                await API.delete(`/api/doctors/${id}`);
                Toast.success('–í—Ä–∞—á —É–¥–∞–ª—ë–Ω');
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        async function save(e) {
            e.preventDefault();

            const data = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                login: document.getElementById('login').value,
                isAdmin: document.getElementById('isAdmin').checked
            };

            const password = document.getElementById('password').value;
            if (password) {
                data.password = password;
            }

            try {
                if (editingId) {
                    await API.put(`/api/doctors/${editingId}`, data);
                    Toast.success('–í—Ä–∞—á –æ–±–Ω–æ–≤–ª—ë–Ω');
                } else {
                    if (!password) {
                        Toast.error('–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤—Ä–∞—á–∞');
                        return;
                    }
                    await API.post('/api/doctors', data);
                    Toast.success('–í—Ä–∞—á –¥–æ–±–∞–≤–ª–µ–Ω');
                }
                closeModal();
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('form').addEventListener('submit', save);
            Modal.setupClickOutside('modal');
        });
    </script>
</body>
</html>
