<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á—ë—Ç—ã - CRM –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .chart-container { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #333; }
        .chart-canvas { width: 100%; height: 300px; }
        .total-card { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .total-amount { font-size: 3rem; font-weight: bold; }
        .total-label { font-size: 1rem; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã</h1>

        <div class="nav">
            <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/patients.html">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
            <a href="/appointments.html">üìÖ –ó–∞–ø–∏—Å–∏</a>
            <a href="/doctors.html">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</a>
            <a href="/services.html">‚öôÔ∏è –£—Å–ª—É–≥–∏</a>
            <a href="/reports.html" class="active">üìä –û—Ç—á—ë—Ç—ã</a>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤...</div>
        </div>

        <div id="content" style="display: none;">
            <div class="total-card">
                <div class="total-amount" id="totalAmount">0</div>
                <div class="total-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥ (‚Ç∏)</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">–î–æ—Ö–æ–¥ –ø–æ –¥–Ω—è–º</div>
                <canvas id="chart" class="chart-canvas"></canvas>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î–æ—Ö–æ–¥ (‚Ç∏)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="error" class="error-state" style="display: none;">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. <a href="#" onclick="loadData()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
        </div>
    </div>

    <div id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        let chart = null;

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            try {
                const response = await API.get('/api/reports');
                const data = response.data;

                document.getElementById('totalAmount').textContent = Currency.format(data.total_income || 0);

                renderTable(data.by_day || []);
                renderChart(data.by_day || []);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function renderTable(byDay) {
            const tbody = document.getElementById('tableBody');

            if (!byDay.length) {
                EmptyState.showInTable(tbody, 2, 'üìä', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                return;
            }

            const sorted = [...byDay].sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sorted.map(d => `
                <tr>
                    <td>${DateUtils.format(d.date)}</td>
                    <td><strong>${Currency.format(d.income)}</strong> ‚Ç∏</td>
                </tr>
            `).join('');
        }

        function renderChart(byDay) {
            const ctx = document.getElementById('chart').getContext('2d');

            if (chart) chart.destroy();

            if (!byDay.length) return;

            const sorted = [...byDay].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sorted.map(d => DateUtils.format(d.date));
            const values = sorted.map(d => d.income);

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '–î–æ—Ö–æ–¥ (‚Ç∏)',
                        data: values,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgb(40, 167, 69)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => Currency.format(value) + ' ‚Ç∏'
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
