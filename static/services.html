<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—Å–ª—É–≥–∏ - CRM –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 20px 0; }
        .service-card { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; transition: transform 0.2s, box-shadow 0.2s; }
        .service-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .service-type { font-size: 12px; color: #007bff; text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
        .service-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .service-notes { color: #666; font-size: 13px; margin-bottom: 12px; }
        .service-actions { display: flex; gap: 8px; }
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .filter-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .filter-btn:hover, .filter-btn.active { background: #007bff; color: white; border-color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è –£—Å–ª—É–≥–∏</h1>

        <div class="nav">
            <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/patients.html">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
            <a href="/appointments.html">üìÖ –ó–∞–ø–∏—Å–∏</a>
            <a href="/doctors.html">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</a>
            <a href="/services.html" class="active">‚öôÔ∏è –£—Å–ª—É–≥–∏</a>
            <a href="/reports.html">üìä –û—Ç—á—ë—Ç—ã</a>
        </div>

        <div class="quick-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ —É—Å–ª—É–≥</div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-success" onclick="openModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button>
        </div>

        <div class="filter-bar" id="filterBar"></div>

        <div class="services-grid" id="servicesGrid"></div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</h2>
            <form id="form">
                <div class="form-group">
                    <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="type">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                    <input type="text" id="type" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞">
                </div>
                <div class="form-group">
                    <label for="notes">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast"></div>

    <script src="/static/js/common.js"></script>
    <script>
        let services = [];
        let editingId = null;
        let activeFilter = null;

        async function loadData() {
            const grid = document.getElementById('servicesGrid');
            Loading.show(grid);

            try {
                const data = await API.get('/api/services');
                services = Array.isArray(data) ? data : (data.data || []);
                document.getElementById('totalCount').textContent = services.length;
                renderFilters();
                render();
            } catch (error) {
                console.error('Error:', error);
                Toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function renderFilters() {
            const types = [...new Set(services.map(s => s.type).filter(Boolean))];
            const filterBar = document.getElementById('filterBar');

            filterBar.innerHTML = `<button class="filter-btn ${!activeFilter ? 'active' : ''}" onclick="setFilter(null)">–í—Å–µ</button>` +
                types.map(t => `<button class="filter-btn ${activeFilter === t ? 'active' : ''}" onclick="setFilter('${t}')">${t}</button>`).join('');
        }

        function setFilter(type) {
            activeFilter = type;
            renderFilters();
            render();
        }

        function render() {
            const grid = document.getElementById('servicesGrid');
            const filtered = activeFilter ? services.filter(s => s.type === activeFilter) : services;

            if (!filtered.length) {
                EmptyState.show(grid, '‚öôÔ∏è', '–ù–µ—Ç —É—Å–ª—É–≥');
                return;
            }

            grid.innerHTML = filtered.map(s => `
                <div class="service-card">
                    <div class="service-type">${s.type || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</div>
                    <div class="service-name">${s.name}</div>
                    <div class="service-notes">${s.notes || '-'}</div>
                    <div class="service-actions">
                        <button class="btn btn-sm btn-warning" onclick="edit(${s.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="remove(${s.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function openModal(service = null) {
            editingId = service?.id || null;
            document.getElementById('modalTitle').textContent = service ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª—É–≥—É' : '–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É';
            document.getElementById('form').reset();

            if (service) {
                document.getElementById('name').value = service.name || '';
                document.getElementById('type').value = service.type || '';
                document.getElementById('notes').value = service.notes || '';
            }

            Modal.open('modal');
        }

        function closeModal() {
            Modal.close('modal');
            editingId = null;
        }

        function edit(id) {
            const service = services.find(s => s.id === id);
            if (service) openModal(service);
        }

        async function remove(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É?')) return;

            try {
                await API.delete(`/api/services/${id}`);
                Toast.success('–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞');
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        async function save(e) {
            e.preventDefault();

            const data = {
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                notes: document.getElementById('notes').value
            };

            try {
                if (editingId) {
                    await API.put(`/api/services/${editingId}`, data);
                    Toast.success('–£—Å–ª—É–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                } else {
                    await API.post('/api/services', data);
                    Toast.success('–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                }
                closeModal();
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('form').addEventListener('submit', save);
            Modal.setupClickOutside('modal');
        });
    </script>
</body>
</html>
