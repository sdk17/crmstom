<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞—Ü–∏–µ–Ω—Ç—ã - CRM –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .nav {
            text-align: center;
            margin: 20px 0;
        }
        .nav a {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .nav a:hover {
            background-color: #0056b3;
        }
        .add-patient {
            background-color: #28a745;
            margin-bottom: 20px;
        }
        .add-patient:hover {
            background-color: #218838;
        }
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        .search-box {
            margin: 20px 0;
            text-align: center;
        }
        .search-box input {
            padding: 10px;
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .patients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .patients-table th,
        .patients-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .patients-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .patients-table tr:hover {
            background-color: #f5f5f5;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-edit {
            background-color: #ffc107;
            color: #000;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        .btn-view {
            background-color: #17a2b8;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-actions {
            text-align: right;
            margin-top: 20px;
        }
        .form-actions button {
            padding: 10px 20px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-save {
            background-color: #28a745;
            color: white;
        }
        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏</h1>
        
        <div class="nav">
            <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/patients.html">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
            <a href="/appointments.html">üìÖ –ó–∞–ø–∏—Å–∏</a>
            <a href="/services.html">ü¶∑ –£—Å–ª—É–≥–∏</a>
            <a href="/reports.html">üìä –û—Ç—á—ë—Ç—ã</a>
        </div>

        <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="quick-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalPatientsCount">3</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="newPatientsCount">0</div>
                <div class="stat-label">–ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="activePatientsCount">3</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgAgeCount">35</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç</div>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ email...">
        </div>

        <button class="nav add-patient" onclick="openAddPatientModal()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
        </button>
        
        <button class="nav" onclick="testFunction()" style="background: #28a745; margin-left: 10px;">
            üß™ –¢–µ—Å—Ç
        </button>
        
        <button class="nav" onclick="testModalClose()" style="background: #ffc107; margin-left: 10px;">
            üîß –¢–µ—Å—Ç –º–æ–¥–∞–ª–∫–∏
        </button>
        
        <button class="nav" onclick="testSavePatient()" style="background: #dc3545; margin-left: 10px;">
            üíæ –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        </button>

        <table class="patients-table" id="patientsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–§–ò–û</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>Email</th>
                    <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                    <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="patientsTableBody">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ -->
    <div id="patientModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</h2>
            <form id="patientForm">
                <div class="form-group">
                    <label for="patientName">–§–ò–û *</label>
                    <input type="text" id="patientName" required>
                </div>
                <div class="form-group">
                    <label for="patientPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="patientPhone">
                </div>
                <div class="form-group">
                    <label for="patientEmail">Email</label>
                    <input type="email" id="patientEmail">
                </div>
                <div class="form-group">
                    <label for="patientBirthDate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" id="patientBirthDate">
                </div>
                <div class="form-group">
                    <label for="patientAddress">–ê–¥—Ä–µ—Å</label>
                    <input type="text" id="patientAddress">
                </div>
                <div class="form-group">
                    <label for="patientNotes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <input type="text" id="patientNotes">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closePatientModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —ç—Ç–æ –±—É–¥–µ—Ç API)
        let patients = [
            {
                id: 1,
                name: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
                phone: "+7 (777) 123-45-67",
                email: "ivanov@example.com",
                birthDate: "1985-03-15",
                address: "–≥. –ê–ª–º–∞—Ç—ã, —É–ª. –ê–±–∞—è, 150",
                notes: "–ê–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –ø–µ–Ω–∏—Ü–∏–ª–ª–∏–Ω",
                lastVisit: "2025-01-15"
            },
            {
                id: 2,
                name: "–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞",
                phone: "+7 (777) 234-56-78",
                email: "petrova@example.com",
                birthDate: "1990-07-22",
                address: "–≥. –ê–ª–º–∞—Ç—ã, —É–ª. –î–æ—Å—Ç—ã–∫, 45",
                notes: "–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å - 2 —Ç—Ä–∏–º–µ—Å—Ç—Ä",
                lastVisit: "2025-01-18"
            },
            {
                id: 3,
                name: "–°–∏–¥–æ—Ä–æ–≤ –ü–µ—Ç—Ä –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á",
                phone: "+7 (777) 345-67-89",
                email: "sidorov@example.com",
                birthDate: "1978-11-08",
                address: "–≥. –ê–ª–º–∞—Ç—ã, —É–ª. –°–∞—Ç–ø–∞–µ–≤–∞, 78",
                notes: "–î–∏–∞–±–µ—Ç 2 —Ç–∏–ø–∞",
                lastVisit: "2025-01-20"
            }
        ];

        let currentEditingId = null;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.openAddPatientModal = function() {
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞');
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞';
            document.getElementById('patientForm').reset();
            document.getElementById('patientModal').style.display = 'block';
        };

        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ closePatientModal

        window.editPatient = function(id) {
            console.log('–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å ID:', id);
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            currentEditingId = id;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞';
            document.getElementById('patientName').value = patient.name;
            document.getElementById('patientPhone').value = patient.phone || '';
            document.getElementById('patientEmail').value = patient.email || '';
            document.getElementById('patientBirthDate').value = patient.birth_date || '';
            document.getElementById('patientAddress').value = patient.address || '';
            document.getElementById('patientNotes').value = patient.notes || '';
            document.getElementById('patientModal').style.display = 'block';
        };

        window.viewPatient = function(id) {
            console.log('–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å ID:', id);
            const patient = patients.find(p => p.id === id);
            if (!patient) return;

            alert(`–ü–∞—Ü–∏–µ–Ω—Ç: ${patient.name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${patient.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\nEmail: ${patient.email || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${formatDate(patient.birth_date)}\n–ê–¥—Ä–µ—Å: ${patient.address || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–ü—Ä–∏–º–µ—á–∞–Ω–∏—è: ${patient.notes || '–Ω–µ—Ç'}\n–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: ${formatDate(patient.last_visit)}`);
        };

        window.deletePatient = async function(id) {
            console.log('–£–¥–∞–ª—è–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å ID:', id);
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞?')) {
                try {
                    const response = await fetch(`/api/patients/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞');
                    
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    await loadPatients();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                    showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞', 'error');
                }
            }
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤');
            loadPatients();
            setupSearch();
            setupForm();
        });

        async function loadPatients() {
            try {
                console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤...');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const tbody = document.getElementById('patientsTableBody');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
                
                const response = await fetch('/api/patients');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                
                patients = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤:', patients.length);
                displayPatients();
                console.log('–ü–∞—Ü–∏–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        function displayPatients() {
            console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ...');
            const tbody = document.getElementById('patientsTableBody');
            if (!tbody) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç patientsTableBody –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            tbody.innerHTML = '';

            patients.forEach(patient => {
                console.log('–î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–∞:', patient.name);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${patient.id}</td>
                    <td>${patient.name}</td>
                    <td>${patient.phone || '-'}</td>
                    <td>${patient.email || '-'}</td>
                    <td>${formatDate(patient.birth_date)}</td>
                    <td>${formatDate(patient.last_visit)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewPatient(${patient.id})">üëÅ</button>
                            <button class="btn btn-edit" onclick="editPatient(${patient.id})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deletePatient(${patient.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            });
        }

        async function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', async function() {
                const searchTerm = this.value;
                
                try {
                    const response = await fetch(`/api/patients?query=${encodeURIComponent(searchTerm)}`);
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
                    
                    const filteredPatients = await response.json();
                    displayFilteredPatients(filteredPatients);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'error');
                }
            });
        }

        function displayFilteredPatients(filteredPatients) {
            const tbody = document.getElementById('patientsTableBody');
            tbody.innerHTML = '';

            filteredPatients.forEach(patient => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${patient.id}</td>
                    <td>${patient.name}</td>
                    <td>${patient.phone || '-'}</td>
                    <td>${patient.email || '-'}</td>
                    <td>${formatDate(patient.birth_date)}</td>
                    <td>${formatDate(patient.last_visit)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewPatient(${patient.id})">üëÅ</button>
                            <button class="btn btn-edit" onclick="editPatient(${patient.id})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deletePatient(${patient.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            });
        }

        function setupForm() {
            const form = document.getElementById('patientForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, –≤—ã–∑—ã–≤–∞–µ–º savePatient...');
                    savePatient();
                });
                console.log('–§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
            } else {
                console.error('–§–æ—Ä–º–∞ —Å id patientForm –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
        }

        // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        window.testFunction = function() {
            console.log('–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞!');
            showNotification('–¢–µ—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
            loadPatients();
        };

        // –¢–µ—Å—Ç –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.testModalClose = function() {
            console.log('–¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞...');
            openAddPatientModal();
            setTimeout(() => {
                console.log('–ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...');
                closePatientModal();
                showNotification('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç—å—Å—è!', 'success');
            }, 2000);
        };

        // –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
        window.testSavePatient = function() {
            console.log('–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞...');
            openAddPatientModal();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            setTimeout(() => {
                document.getElementById('patientName').value = '–¢–µ—Å—Ç–æ–≤—ã–π –ü–∞—Ü–∏–µ–Ω—Ç';
                document.getElementById('patientPhone').value = '+7 (777) 999-99-99';
                document.getElementById('patientEmail').value = 'test@example.com';
                
                console.log('–§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –≤—ã–∑—ã–≤–∞–µ–º savePatient...');
                savePatient();
            }, 1000);
        };

        // –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤—ã—à–µ –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ

        window.savePatient = async function() {
            const formData = {
                name: document.getElementById('patientName').value,
                phone: document.getElementById('patientPhone').value || '',
                email: document.getElementById('patientEmail').value || '',
                birth_date: document.getElementById('patientBirthDate').value || '',
                address: document.getElementById('patientAddress').value || '',
                notes: document.getElementById('patientNotes').value || ''
            };

            try {
                if (currentEditingId) {
                    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞
                    const response = await fetch(`/api/patients/${currentEditingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞');
                    
                    const result = await response.json();
                    showNotification(result.message, 'success');
                } else {
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞
                    const response = await fetch('/api/patients', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞');
                    
                    const result = await response.json();
                    showNotification(result.message, 'success');
                }

                console.log('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤...');
                await loadPatients();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                closePatientModal();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞', 'error');
            }
        }

        window.closePatientModal = function() {
            console.log('–ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞');
            const modal = document.getElementById('patientModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫—Ä—ã—Ç–æ');
            } else {
                console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
            }
            const form = document.getElementById('patientForm');
            if (form) {
                form.reset();
                console.log('–§–æ—Ä–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
            } else {
                console.error('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞!');
            }
            currentEditingId = null;
            console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∑–∞–∫—Ä—ã—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('patientModal');
            if (event.target === modal) {
                closePatientModal();
            }
        }
    </script>
</body>
</html>
