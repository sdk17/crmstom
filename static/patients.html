<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞—Ü–∏–µ–Ω—Ç—ã - CRM –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <div class="container">
        <h1>üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</h1>

        <div class="nav">
            <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/patients.html" class="active">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
            <a href="/appointments.html">üìÖ –ó–∞–ø–∏—Å–∏</a>
            <a href="/doctors.html">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</a>
            <a href="/services.html">‚öôÔ∏è –£—Å–ª—É–≥–∏</a>
            <a href="/reports.html">üìä –û—Ç—á—ë—Ç—ã</a>
        </div>

        <div class="quick-stats" id="statsContainer">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ</div>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ email...">
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-success" onclick="openModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>–§–ò–û</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>Email</th>
                    <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</h2>
            <form id="form">
                <div class="form-group">
                    <label for="name">–§–ò–û *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="birthDate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" id="birthDate">
                </div>
                <div class="form-group">
                    <label for="address">–ê–¥—Ä–µ—Å</label>
                    <input type="text" id="address">
                </div>
                <div class="form-group">
                    <label for="notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast"></div>

    <script src="/static/js/common.js"></script>
    <script>
        let patients = [];
        let editingId = null;

        // Load patients
        async function loadData() {
            const tbody = document.getElementById('tableBody');
            Loading.showInTable(tbody, 5);

            try {
                patients = await API.get('/api/patients');
                render();
                document.getElementById('totalCount').textContent = patients.length;
            } catch (error) {
                console.error('Error:', error);
                Toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // Render table
        function render(data = patients) {
            const tbody = document.getElementById('tableBody');

            if (!data || data.length === 0) {
                EmptyState.showInTable(tbody, 5, 'üë•', '–ù–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤');
                return;
            }

            tbody.innerHTML = data.map(p => `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${Phone.format(p.phone) || '-'}</td>
                    <td>${p.email || '-'}</td>
                    <td>${DateUtils.format(p.birth_date)}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-warning" onclick="edit(${p.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="remove(${p.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Search
        async function search(query) {
            if (!query.trim()) {
                render();
                return;
            }

            try {
                const results = await API.get(`/api/patients?query=${encodeURIComponent(query)}`);
                render(results);
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
            }
        }

        // Open modal
        function openModal(patient = null) {
            editingId = patient?.id || null;
            document.getElementById('modalTitle').textContent = patient ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞' : '–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞';
            document.getElementById('form').reset();

            if (patient) {
                document.getElementById('name').value = patient.name || '';
                document.getElementById('phone').value = patient.phone || '';
                document.getElementById('email').value = patient.email || '';
                document.getElementById('birthDate').value = DateUtils.toInputFormat(patient.birth_date);
                document.getElementById('address').value = patient.address || '';
                document.getElementById('notes').value = patient.notes || '';
            }

            Modal.open('modal');
        }

        function closeModal() {
            Modal.close('modal');
            editingId = null;
        }

        // Edit
        function edit(id) {
            const patient = patients.find(p => p.id === id);
            if (patient) openModal(patient);
        }

        // Delete
        async function remove(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞?')) return;

            try {
                await API.delete(`/api/patients/${id}`);
                Toast.success('–ü–∞—Ü–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω');
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        // Save
        async function save(e) {
            e.preventDefault();

            const data = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                birth_date: document.getElementById('birthDate').value,
                address: document.getElementById('address').value,
                notes: document.getElementById('notes').value
            };

            try {
                if (editingId) {
                    await API.put(`/api/patients/${editingId}`, data);
                    Toast.success('–ü–∞—Ü–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω');
                } else {
                    await API.post('/api/patients', data);
                    Toast.success('–ü–∞—Ü–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
                }
                closeModal();
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            document.getElementById('form').addEventListener('submit', save);

            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => search(e.target.value), 300);
            });

            Modal.setupClickOutside('modal');
        });
    </script>
</body>
</html>
