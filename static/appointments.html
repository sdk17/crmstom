<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–ø–∏—Å–∏ - CRM –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .view-toggle { text-align: center; margin: 20px 0; }
        .view-toggle button { padding: 10px 20px; margin: 0 5px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; }
        .view-toggle button.active { background: #007bff; color: white; }

        .week-navigation { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        .week-nav-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .week-nav-btn:hover { background: #0056b3; }
        .current-week { font-size: 18px; font-weight: 600; }

        .weekly-calendar { display: grid; grid-template-columns: 70px repeat(7, 1fr); gap: 1px; background: #ddd; border-radius: 8px; overflow: hidden; }
        .time-slot { background: #f8f9fa; padding: 8px; text-align: center; font-size: 12px; font-weight: 600; }
        .day-header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 12px 8px; text-align: center; }
        .day-name { font-size: 12px; opacity: 0.9; }
        .day-number { font-size: 16px; font-weight: bold; }
        .time-cell { background: white; min-height: 35px; cursor: pointer; position: relative; transition: background 0.2s; }
        .time-cell:hover { background: #f0f7ff; }
        .time-cell.today { background: #fff3cd; }
        .appointment-chip { position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; background: #007bff; color: white; padding: 2px 4px; border-radius: 3px; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ –ó–∞–ø–∏—Å–∏</h1>

        <div class="nav">
            <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/patients.html">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</a>
            <a href="/appointments.html" class="active">üìÖ –ó–∞–ø–∏—Å–∏</a>
            <a href="/doctors.html">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</a>
            <a href="/services.html">‚öôÔ∏è –£—Å–ª—É–≥–∏</a>
            <a href="/reports.html">üìä –û—Ç—á—ë—Ç—ã</a>
        </div>

        <div class="quick-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="scheduledCount">-</div>
                <div class="stat-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="completedCount">-</div>
                <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="btn btn-success" onclick="openModal()">‚ûï –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
        </div>

        <div class="view-toggle">
            <button id="calendarBtn" class="active" onclick="switchView('calendar')">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
            <button id="tableBtn" onclick="switchView('table')">üìã –°–ø–∏—Å–æ–∫</button>
        </div>

        <!-- Calendar View -->
        <div id="calendarView">
            <div class="week-navigation">
                <button class="week-nav-btn" onclick="changeWeek(-1)">‚Üê –ü—Ä–µ–¥.</button>
                <div class="current-week" id="weekDisplay">-</div>
                <button class="week-nav-btn" onclick="changeWeek(1)">–°–ª–µ–¥. ‚Üí</button>
            </div>
            <div class="weekly-calendar" id="calendar"></div>
        </div>

        <!-- Table View -->
        <div id="tableView" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>–ü–∞—Ü–∏–µ–Ω—Ç</th>
                        <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                        <th>–£—Å–ª—É–≥–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
            <form id="form">
                <div class="form-group">
                    <label for="patient">–ü–∞—Ü–∏–µ–Ω—Ç *</label>
                    <select id="patient" required></select>
                </div>
                <div class="form-group">
                    <label for="date">–î–∞—Ç–∞ *</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="time">–í—Ä–µ–º—è *</label>
                    <select id="time" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="service">–£—Å–ª—É–≥–∞ *</label>
                    <select id="service" required></select>
                </div>
                <div class="form-group">
                    <label for="doctor">–í—Ä–∞—á *</label>
                    <select id="doctor" required></select>
                </div>
                <div class="form-group">
                    <label for="price">–¶–µ–Ω–∞ (‚Ç∏)</label>
                    <input type="number" id="price" min="0">
                </div>
                <div class="form-group">
                    <label for="duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
                    <input type="number" id="duration" min="15" value="30">
                </div>
                <div class="form-group">
                    <label for="notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea id="notes" rows="2"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast"></div>

    <script src="/static/js/common.js"></script>
    <script>
        let appointments = [];
        let patients = [];
        let services = [];
        let doctors = [];
        let editingId = null;
        let currentView = 'calendar';
        let currentWeek = new Date();

        const TIME_SLOTS = [];
        for (let h = 8; h <= 18; h++) {
            TIME_SLOTS.push(`${String(h).padStart(2,'0')}:00`);
            if (h < 18) TIME_SLOTS.push(`${String(h).padStart(2,'0')}:30`);
        }

        // Load all data
        async function loadData() {
            try {
                const [patientsRes, appointmentsRes, servicesRes, doctorsRes] = await Promise.all([
                    API.get('/api/patients'),
                    API.get('/api/appointments'),
                    API.get('/api/services'),
                    API.get('/api/doctors')
                ]);

                patients = Array.isArray(patientsRes) ? patientsRes : (patientsRes.data || []);
                appointments = Array.isArray(appointmentsRes) ? appointmentsRes : (appointmentsRes.data || []);
                services = Array.isArray(servicesRes) ? servicesRes : (servicesRes.data || []);
                doctors = Array.isArray(doctorsRes) ? doctorsRes : (doctorsRes.data || []);

                updateStats();
                render();
                populateSelects();
            } catch (error) {
                console.error('Error:', error);
                Toast.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = appointments.length;
            document.getElementById('scheduledCount').textContent = appointments.filter(a => a.status === 'scheduled').length;
            document.getElementById('completedCount').textContent = appointments.filter(a => a.status === 'completed').length;
        }

        function render() {
            if (currentView === 'calendar') renderCalendar();
            else renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');

            if (!appointments.length) {
                EmptyState.showInTable(tbody, 6, 'üìÖ', '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π');
                return;
            }

            tbody.innerHTML = appointments.map(a => `
                <tr>
                    <td><strong>${a.patient_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></td>
                    <td>${DateUtils.format(a.date)} ${a.time || ''}</td>
                    <td>${a.service || '-'}</td>
                    <td>${renderStatusBadge(a.status)}</td>
                    <td>${Currency.formatWithSymbol(a.price)}</td>
                    <td class="actions">
                        ${a.status === 'scheduled' ? `<button class="btn btn-sm btn-success" onclick="complete(${a.id})">‚úì</button>` : ''}
                        <button class="btn btn-sm btn-warning" onclick="edit(${a.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="remove(${a.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const weekStart = getWeekStart(currentWeek);

            // Update week display
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekDisplay').textContent =
                `${weekStart.toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'})} - ${weekEnd.toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'})}`;

            const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            const today = new Date();

            let html = '<div class="time-slot"></div>';

            // Day headers
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                html += `<div class="day-header"><div class="day-name">${days[i]}</div><div class="day-number">${d.getDate()}</div></div>`;
            }

            // Time rows
            TIME_SLOTS.forEach(time => {
                html += `<div class="time-slot">${time}</div>`;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(d.getDate() + i);
                    const dateStr = d.toISOString().split('T')[0];
                    const isToday = d.toDateString() === today.toDateString();
                    const apt = findAppointment(dateStr, time);

                    html += `<div class="time-cell${isToday ? ' today' : ''}" onclick="openModalForSlot('${dateStr}', '${time}')">`;
                    if (apt) {
                        const color = getColor(apt.service);
                        html += `<div class="appointment-chip" style="background:${color}" onclick="event.stopPropagation(); viewAppointment(${apt.id})">${apt.patient_name || '–ó–∞–ø–∏—Å—å'}</div>`;
                    }
                    html += '</div>';
                }
            });

            calendar.innerHTML = html;
        }

        function findAppointment(dateStr, time) {
            return appointments.find(a => {
                const aptDate = a.date.split('T')[0];
                return aptDate === dateStr && a.time === time;
            });
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function changeWeek(dir) {
            currentWeek.setDate(currentWeek.getDate() + (dir * 7));
            renderCalendar();
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('calendarView').style.display = view === 'calendar' ? 'block' : 'none';
            document.getElementById('tableView').style.display = view === 'table' ? 'block' : 'none';
            document.getElementById('calendarBtn').classList.toggle('active', view === 'calendar');
            document.getElementById('tableBtn').classList.toggle('active', view === 'table');
            render();
        }

        function getColor(service) {
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#fd7e14'];
            let hash = 0;
            for (let i = 0; i < (service || '').length; i++) hash = service.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        function populateSelects() {
            // Patients
            const patientSelect = document.getElementById('patient');
            patientSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞</option>' +
                patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            // Services
            const serviceSelect = document.getElementById('service');
            serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>' +
                services.map(s => `<option value="${s.name}">${s.name}</option>`).join('');

            // Doctors
            const doctorSelect = document.getElementById('doctor');
            doctorSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</option>' +
                doctors.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

            // Time slots
            const timeSelect = document.getElementById('time');
            timeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>' +
                TIME_SLOTS.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function openModal(apt = null) {
            editingId = apt?.id || null;
            document.getElementById('modalTitle').textContent = apt ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å' : '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å';
            document.getElementById('form').reset();

            if (apt) {
                document.getElementById('patient').value = String(apt.patient_id || '');
                document.getElementById('date').value = DateUtils.toInputFormat(apt.date) || '';
                document.getElementById('time').value = apt.time || '';
                document.getElementById('service').value = apt.service || '';
                document.getElementById('doctor').value = apt.doctor || '';
                document.getElementById('price').value = apt.price || '';
                document.getElementById('duration').value = apt.duration || 30;
                document.getElementById('notes').value = apt.notes || '';
            }

            Modal.open('modal');
        }

        function openModalForSlot(dateStr, time) {
            if (findAppointment(dateStr, time)) return;
            document.getElementById('form').reset();
            document.getElementById('date').value = dateStr;
            document.getElementById('time').value = time;
            editingId = null;
            document.getElementById('modalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å';
            Modal.open('modal');
        }

        function closeModal() {
            Modal.close('modal');
            editingId = null;
        }

        function edit(id) {
            const apt = appointments.find(a => a.id === id);
            if (apt) openModal(apt);
        }

        function viewAppointment(id) {
            const apt = appointments.find(a => a.id === id);
            if (!apt) return;
            const msg = `–ü–∞—Ü–∏–µ–Ω—Ç: ${apt.patient_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n–£—Å–ª—É–≥–∞: ${apt.service}\n–î–∞—Ç–∞: ${DateUtils.format(apt.date)} ${apt.time}\n–°—Ç–∞—Ç—É—Å: ${apt.status}\n–¶–µ–Ω–∞: ${Currency.formatWithSymbol(apt.price)}`;
            alert(msg);
        }

        async function complete(id) {
            try {
                const apt = appointments.find(a => a.id === id);
                if (!apt) return;
                await API.put(`/api/appointments/${id}`, {...apt, status: 'completed'});
                Toast.success('–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞');
            }
        }

        async function remove(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            try {
                await API.delete(`/api/appointments/${id}`);
                Toast.success('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        async function save(e) {
            e.preventDefault();

            const dateVal = document.getElementById('date').value;
            const timeVal = document.getElementById('time').value;

            const data = {
                patient_id: parseInt(document.getElementById('patient').value),
                date: `${dateVal}T${timeVal}:00Z`,
                time: timeVal,
                service: document.getElementById('service').value,
                doctor: document.getElementById('doctor').value,
                price: parseFloat(document.getElementById('price').value) || 0,
                duration: parseInt(document.getElementById('duration').value) || 30,
                notes: document.getElementById('notes').value,
                status: editingId ? (appointments.find(a => a.id === editingId)?.status || 'scheduled') : 'scheduled'
            };

            try {
                if (editingId) {
                    await API.put(`/api/appointments/${editingId}`, data);
                    Toast.success('–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                } else {
                    await API.post('/api/appointments', data);
                    Toast.success('–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞');
                }
                closeModal();
                loadData();
            } catch (error) {
                Toast.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('form').addEventListener('submit', save);
            Modal.setupClickOutside('modal');
        });
    </script>
</body>
</html>
